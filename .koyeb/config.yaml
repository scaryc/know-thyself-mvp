# Koyeb configuration for Know Thyself MVP Backend
# This file enables Git-driven deployment with automatic builds

services:
  - name: know-thyself-backend
    type: web
    instance_type: nano  # Free tier
    regions:
      - fra  # Frankfurt (closest to Slovakia)
    ports:
      - port: 8000
        protocol: http
    routes:
      - path: /
        port: 8000

    # Build configuration
    build:
      buildpack: nodejs
      node_version: "18"
      build_command: npm install && npx prisma generate

    # Run configuration
    run:
      command: npx prisma db push --accept-data-loss --skip-generate && npm run server

    # Auto-scaling
    scaling:
      min: 1
      max: 1

    # Health checks
    health_check:
      http:
        path: /api/health
        port: 8000
        interval_sec: 30
        timeout_sec: 5
        healthy_threshold: 1
        unhealthy_threshold: 3

    # Environment variables (set in Koyeb dashboard)
    # - DATABASE_URL
    # - ANTHROPIC_API_KEY
    # - NODE_ENV=production
    # - PORT=8000
    # - FRONTEND_URL
